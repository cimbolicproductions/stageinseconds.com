name: Security Audit

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./apps/web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './apps/web/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        continue-on-error: true
        run: |
          npm audit --audit-level=high --json > audit-report.json
          cat audit-report.json

      - name: Check audit results
        run: |
          # Parse audit results
          VULNERABILITIES=$(cat audit-report.json | grep -o '"high":[0-9]*' | grep -o '[0-9]*' || echo "0")
          CRITICAL=$(cat audit-report.json | grep -o '"critical":[0-9]*' | grep -o '[0-9]*' || echo "0")

          echo "High severity vulnerabilities: $VULNERABILITIES"
          echo "Critical severity vulnerabilities: $CRITICAL"

          TOTAL=$((VULNERABILITIES + CRITICAL))

          if [ $TOTAL -gt 0 ]; then
            echo "::error::Found $TOTAL high/critical vulnerabilities"
            echo "VULNERABILITIES_FOUND=true" >> $GITHUB_ENV
            echo "VULNERABILITY_COUNT=$TOTAL" >> $GITHUB_ENV
            exit 1
          else
            echo "âœ… No high or critical vulnerabilities found"
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_ENV
          fi

      - name: Create issue for vulnerabilities
        if: failure() && github.event_name == 'schedule' && env.VULNERABILITIES_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditReport = JSON.parse(fs.readFileSync('./apps/web/audit-report.json', 'utf8'));

            const title = `ðŸ”’ Security Alert: ${process.env.VULNERABILITY_COUNT} High/Critical Vulnerabilities Detected`;
            const body = `## Security Vulnerabilities Found

            The automated security scan has detected **${process.env.VULNERABILITY_COUNT}** high or critical severity vulnerabilities.

            ### Summary
            - **High**: ${auditReport.metadata?.vulnerabilities?.high || 0}
            - **Critical**: ${auditReport.metadata?.vulnerabilities?.critical || 0}

            ### Actions Required
            1. Review the vulnerabilities by running \`npm audit\` locally
            2. Update affected packages using \`npm audit fix\`
            3. For breaking changes, manually update packages in \`package.json\`
            4. Test thoroughly after updates

            ### Audit Command
            \`\`\`bash
            cd apps/web
            npm audit --audit-level=high
            npm audit fix
            \`\`\`

            **Auto-generated by Security Audit workflow**
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security'
            });

            const existingIssue = issues.data.find(issue => issue.title.includes('Security Alert'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automated']
              });
            }
