{
  "task": "Task 5: Set Up CI/CD Pipeline",
  "context": {
    "project": "stageinseconds.com",
    "previousProgress": {
      "task-1": "completed - ESLint, Prettier, and pre-commit hooks configured",
      "task-2": "completed - Database migrations with Drizzle ORM",
      "task-3": "completed - Unit tests for validators, auth, and SSRF protection",
      "task-4-part-1": "completed - Integration test infrastructure (db helpers, api helpers, MSW mocks)",
      "task-4-part-2": "completed - Auth integration tests (16 tests, skipped)",
      "task-4-part-3": "completed - Billing integration tests (29 tests, skipped)",
      "task-4-part-4": "completed - Photo processing integration tests (39 tests, skipped)",
      "task-4-part-5": "completed - Job management integration tests (20 tests, skipped) + DELETE endpoint"
    },
    "currentTask": "task-5",
    "status": "not started",
    "totalTestCount": "104 tests (16 auth + 29 billing + 39 photo processing + 20 job management)"
  },
  "objective": "Set up a comprehensive GitHub Actions CI/CD pipeline for automated testing, security scanning, and deployment to ensure code quality and production readiness.",
  "requirements": {
    "workflows": {
      "test": {
        "file": ".github/workflows/test.yml",
        "triggers": ["push to main", "pull requests"],
        "jobs": [
          "Setup Node.js 20",
          "Install dependencies (npm ci)",
          "Run linting (npm run lint)",
          "Run type checking (tsc --noEmit)",
          "Setup PostgreSQL service for integration tests",
          "Run database migrations on test DB",
          "Run unit tests (npm run test:unit)",
          "Run integration tests (npm run test:integration)",
          "Upload coverage to Codecov (optional)",
          "Fail if coverage < 70%"
        ],
        "notes": [
          "Use PostgreSQL service container for tests",
          "Set TEST_DATABASE_URL to connect to PostgreSQL service",
          "Run migrations before tests using npm run db:migrate",
          "All 104 tests are currently skipped, so tests will pass but coverage will be 0%",
          "Coverage requirement should be lenient until tests are unskipped"
        ]
      },
      "deploy": {
        "file": ".github/workflows/deploy.yml",
        "triggers": ["push to main (after tests pass)"],
        "jobs": [
          "Deploy to Vercel production",
          "Comment on PR with deployment URL (if applicable)",
          "Run basic smoke tests on deployed URL"
        ],
        "notes": [
          "Requires VERCEL_TOKEN and VERCEL_ORG_ID secrets",
          "Use vercel-action for deployment",
          "Only deploy if test workflow passes",
          "Production deployment for main branch, preview for PRs"
        ]
      },
      "security": {
        "file": ".github/workflows/security.yml",
        "triggers": ["daily cron (0 0 * * *)", "pull requests"],
        "jobs": [
          "Run npm audit",
          "Check for known vulnerabilities",
          "Fail if high/critical vulnerabilities found",
          "Create issue if vulnerabilities detected"
        ],
        "notes": [
          "Use npm audit --audit-level=high",
          "Consider using Snyk or Dependabot for advanced scanning",
          "Auto-create GitHub issues for critical vulnerabilities"
        ]
      }
    },
    "documentation": {
      "branchProtection": {
        "file": ".github/BRANCH_PROTECTION.md",
        "content": [
          "Require pull request before merging to main",
          "Require status checks to pass (test workflow, linting)",
          "Require branches to be up to date before merging",
          "Require linear history (no merge commits)",
          "Require code review from at least 1 person",
          "Dismiss stale pull request approvals when new commits pushed"
        ]
      },
      "secrets": {
        "file": ".github/SECRETS.md",
        "requiredSecrets": [
          "DATABASE_URL - Production database connection string",
          "TEST_DATABASE_URL - Test database for CI (use PostgreSQL service in GitHub Actions)",
          "STRIPE_SECRET_KEY - Stripe API key for payments",
          "STRIPE_WEBHOOK_SECRET - Stripe webhook signing secret",
          "GEMINI_API_KEY - Google Gemini API key for AI processing",
          "VERCEL_TOKEN - Vercel deployment token (optional)",
          "VERCEL_ORG_ID - Vercel organization ID (optional)",
          "CODECOV_TOKEN - Codecov upload token (optional)"
        ],
        "notes": [
          "Document how to obtain each secret",
          "Mark optional secrets clearly",
          "Include setup instructions for local development"
        ]
      }
    },
    "dependabot": {
      "file": ".github/dependabot.yml",
      "config": [
        "Check npm dependencies weekly",
        "Auto-create PRs for security updates",
        "Group non-security updates",
        "Set max open PRs limit to 5"
      ]
    },
    "readme": {
      "file": "README.md",
      "updates": [
        "Add CI/CD status badges (test workflow, coverage if using Codecov)",
        "Add deployment status badge (if using Vercel)",
        "Document how to run tests locally",
        "Document required environment variables",
        "Link to .github/SECRETS.md for secret setup"
      ]
    }
  },
  "technicalDetails": {
    "testDatabase": {
      "setup": "Use PostgreSQL service container in GitHub Actions",
      "version": "15 or 16",
      "connectionString": "postgresql://postgres:postgres@localhost:5432/test_db",
      "migrations": "Run npm run db:migrate before tests",
      "cleanup": "teardownTestDb() handles cleanup between tests"
    },
    "nodeVersion": "20.x",
    "packageManager": "npm",
    "workingDirectory": "apps/web/",
    "scripts": {
      "lint": "eslint .",
      "test:unit": "vitest run test/auth test/utils test/security",
      "test:integration": "vitest run test/api test/helpers",
      "test:coverage": "vitest run --coverage",
      "db:migrate": "tsx src/db/migrate.ts"
    }
  },
  "verification": {
    "local": [
      "Ensure all environment variables are set in .env",
      "Run npm run lint (should pass)",
      "Run npm run test:unit (should pass)",
      "Run npm run test:integration (104 tests skipped)",
      "Check that workflows validate correctly (use act or GitHub CLI)"
    ],
    "github": [
      "Push to a feature branch",
      "Create a pull request",
      "Verify test workflow runs and passes",
      "Verify security workflow runs",
      "Merge PR and verify deploy workflow runs (if configured)",
      "Check GitHub Actions tab for all workflow runs"
    ]
  },
  "deliverables": [
    ".github/workflows/test.yml",
    ".github/workflows/deploy.yml",
    ".github/workflows/security.yml",
    ".github/BRANCH_PROTECTION.md",
    ".github/SECRETS.md",
    ".github/dependabot.yml",
    "README.md (updated with badges and CI/CD documentation)"
  ],
  "notes": [
    "All integration tests are currently skipped due to dev server routing issues",
    "Coverage will be low initially - adjust coverage threshold or make it lenient",
    "Deployment workflow is optional if not deploying to Vercel yet",
    "Focus on getting test and security workflows working first",
    "Branch protection rules are documented but must be configured manually in GitHub repo settings",
    "Consider using GitHub's built-in Dependabot instead of separate workflow",
    "Test workflow should work with PostgreSQL service container",
    "Environment variables should be stored as GitHub Secrets for security"
  ],
  "instruction": "Please complete Task 5: Set up comprehensive GitHub Actions CI/CD pipeline with test, deploy, and security workflows. Create all required workflow files, documentation, and update README with badges. Ensure the test workflow runs all tests (even if skipped) and the security workflow checks for vulnerabilities. Make the pipeline production-ready but lenient enough to work with currently skipped tests."
}
